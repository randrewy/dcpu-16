/*****************************************************************************
*     DCPU Virtual Machine module                                            *
*                                                                            *
*     TODO:    Skip and PC behavior?                                         *
*              Interrupts                                                    *
*                                                                            *
******************************************************************************/
#include<iostream>
#include<stdio.h>
#include<map>
#include "inc\vm.h"
#include "inc\DCPU_disasm.h"
#include "inc\Lem\LEM1802.h"
/*****************************************************************************/
#include <string>
#include <sstream>


/*****************************************************************************
*         SET A, 0x0030                                                      *
*         SET [0x0020], 0x1000                                               *
*         SUB A, [0x1000]                                                    *
*         IFN A, 0x0010                                                      *
*           SET PC, label1                                                   *
*         SET I, 10                                                          *
*         SET A, 0x2000                                                      *
*                                                                            *
*       :label2                                                              *
*         SET [I+0x2000], [A]                                                *
*         SUB I, 1                                                           *
*         IFN I, 0                                                           *
*           SET PC, label2                                                   *
*         SET X, 4                                                           *
*         JSR subroutine3                                                    *
*         SET PC, label1                                                     *
*                                                                            *
*       :subroutine3                                                         *
*         SHL X, 4                                                           *
*         SET PC, POP                                                        *
*                                                                            *
*       :label1                                                              *
*         SET PC, label1                                                     *
******************************************************************************/
DCPU::Word prj[] = { 
	0x7c01, 0x0030, 0x7fc1, 0x0020, 0x1000, 0x7803, 0x1000, 0xc413,
	0x7f81, 0x0019, 0xacc1, 0x7c01, 0x2000, 0x22c1, 0x2000, 0x88c3,
	0x84d3, 0xbb81, 0x9461, 0x7c20, 0x0017, 0x7f81, 0x0019, 0x946f,
	0x6381, 0xeb81, 0x0000
};

// same with long literals
/*****************************************************************************
*         SET A, 0x0030                                                      *
*         SET [0x0020], 0x1000                                               *
*         SUB A, [0x1000]                                                    *
*         IFN A, 0x0010                                                      *
*           SET PC, label1                                                   *
*         SET I, 10                                                          *
*         SET A, 0x2000                                                      *
*                                                                            *
*       :label2                                                              *
*         SET [I+0x2000], [A]                                                *
*         SUB I, 1                                                           *
*         IFN I, 0                                                           *
*           SET PC, label2                                                   *
*         SET X, 4                                                           *
*         JSR subroutine3                                                    *
*         SET PC, label1                                                     *
*                                                                            *
*       :subroutine3                                                         *
*         SHL X, 4                                                           *
*         SET PC, POP                                                        *
*                                                                            *
*       :label1                                                              *
*         SET PC, label1                                                     *
******************************************************************************/
DCPU::Word prj2[] = { 
	0x7c01, 0x0030, 0x7fc1, 0x0020, 0x1000, 0x7803, 0x1000, 0xc413,
	0x7f81, 0x001a, 0xacc1, 0x7c01, 0x2000, 0x22c1, 0x2000, 0x88c3,
	0x84d3, 0x7f81, 0x000d, 0x9461, 0x7c20, 0x0018, 0x7f81, 0x001a,
	0x946f, 0x6381, 0x7f81, 0x001a, 0x0000
};

DCPU::Word prj3[] = {
	0x7c20, 0x00f3, 0x8461, 0x9081, 0x8401, 0x7c21, 0x0145,
	0x7c20, 0x0115, 0x8461, 0xc081, 0x8801, 0x7c21, 0x0166,
	0x7c20, 0x0115, 0x84c1, 0x1801, 0x8c02, 0x86d3, 0x02e1,
	0x7c20, 0x0109, 0x88c2, 0xc4d3, 0x7f81, 0x0011, 0x7d40,
	0x00ba, 0x7c01, 0xb402, 0x7c21, 0x12d0, 0x7c41, 0x02dd,
	0x7c20, 0x004d, 0x83d2, 0x02dd, 0x7f81, 0x002e, 0x7c21,
	0x003c, 0x8401, 0x7a40, 0x02dd, 0x7c01, 0x4cae, 0x7c21,
	0x74fa, 0x7c41, 0x02de, 0x7c20, 0x004d, 0x83d2, 0x02de,
	0x7f81, 0x0043, 0x9001, 0x8c21, 0x7a40, 0x02de, 0x9801,
	0x7c21, 0x4cae, 0x7a40, 0x02de, 0x83d3, 0x02dd, 0x7c20,
	0x0060, 0x83d3, 0x02de, 0x7c20, 0x0076, 0x7f81, 0x0043,
	0x1301, 0x1701, 0x8141, 0x7ca1, 0x02e1, 0x84c1, 0x3481,
	0x0192, 0x0692, 0x0001, 0x1941, 0x88c2, 0x88a2, 0xc4d6,
	0x7f81, 0x0053, 0x60a1, 0x6081, 0x6381, 0x8801, 0x7a40,
	0x02dd, 0x7852, 0x02e0, 0x6381, 0x0801, 0x0bc1, 0x02e0,
	0x7c21, 0x0187, 0xb822, 0x7c20, 0x012a, 0x7801, 0x02dc,
	0x8c02, 0x7c21, 0x0187, 0x7c20, 0x0115, 0x6381, 0x8401,
	0x7a40, 0x02de, 0x8832, 0x7c20, 0x009a, 0x8432, 0x7fc1,
	0x01f4, 0x0208, 0x7fd2, 0x01ea, 0x0208, 0x7c20, 0x00a6,
	0x7ca1, 0x01a8, 0xc0a2, 0x78c1, 0x0208, 0x39a1, 0x88c2,
	0x88a2, 0x85d3, 0x7f81, 0x008a, 0x7801, 0x02dc, 0x9002,
	0x7c21, 0x01a8, 0x8461, 0xc081, 0x7c20, 0x0115, 0x6381,
	0x8001, 0x7a40, 0x02de, 0x8412, 0x7fc1, 0x01ea, 0x0208,
	0x8413, 0x7fc1, 0x01fe, 0x0208, 0x6381, 0x8bd2, 0x02df,
	0x6381, 0x8fd2, 0x02df, 0x6381, 0x8bc1, 0x02df, 0x7c81,
	0x0221, 0x7c20, 0x00df, 0xc401, 0xc421, 0xc441, 0x7c61,
	0x2048, 0x7a40, 0x02de, 0x6381, 0x7c12, 0x4cae, 0x7c20,
	0x00bf, 0x0160, 0x0701, 0x0b01, 0x1b01, 0x1f01, 0x0f01,
	0x1301, 0x1701, 0x9401, 0x7a40, 0x02de, 0x8832, 0x87c1,
	0x02df, 0x8c33, 0x7f81, 0x00d7, 0x8412, 0x7c81, 0x0209,
	0x8413, 0x7c81, 0x0215, 0x7c20, 0x00df, 0x60a1, 0x6081,
	0x6061, 0x60e1, 0x60c1, 0x6041, 0x6021, 0x6381, 0x7ca1,
	0x01c9, 0xc0a2, 0x10c1, 0x39a1, 0x88c2, 0x88a2, 0x85d3,
	0x7f81, 0x00e3, 0x7801, 0x02dc, 0x9402, 0x7c21, 0x01c9,
	0x8461, 0xc081, 0x7c20, 0x0115, 0x6381, 0x1a00, 0x88c3,
	0x1a20, 0x7ce1, 0x022d, 0x84a1, 0x3c12, 0x5c32, 0x0001,
	0x1ec1, 0x02e1, 0x7ce2, 0x0023, 0x88a2, 0x78b3, 0x02dc,
	0x7f81, 0x00f9, 0x84d2, 0x6381, 0x7f81, 0x00f4, 0x5821,
	0x02e1, 0x8c22, 0x18a1, 0x88a2, 0x7ca2, 0x0030, 0x1621,
	0x0002, 0x7c20, 0x0115, 0x6381, 0x0f01, 0x1301, 0x0301,
	0x7c04, 0x0020, 0x7802, 0x0144, 0xa46f, 0xb48f, 0x106b,
	0x2501, 0x0d0b, 0x8822, 0x8802, 0x8533, 0x7f81, 0x011f,
	0x6001, 0x6081, 0x6061, 0x6381, 0x0301, 0x0701, 0x0f01,
	0x1f01, 0x84e1, 0x0061, 0xac68, 0x0f01, 0xac06, 0x88e2,
	0x8414, 0x7f81, 0x012f, 0x6121, 0x7d22, 0x0030, 0x88e3,
	0x8822, 0x84f4, 0x7f81, 0x0137, 0x60e1, 0x6061, 0x6021,
	0x6001, 0x6381, 0x8000, 0x003d, 0x003d, 0x003d, 0x003d,
	0x003d, 0x0020, 0x0044, 0x0043, 0x0050, 0x0055, 0x002d,
	0x0031, 0x0036, 0x0020, 0x0044, 0x0069, 0x0061, 0x0067,
	0x006e, 0x006f, 0x0073, 0x0074, 0x0069, 0x0063, 0x0073,
	0x0020, 0x003d, 0x003d, 0x003d, 0x003d, 0x003d, 0x003d,
	0x0000, 0x0020, 0x0044, 0x0069, 0x0073, 0x0063, 0x006f,
	0x0076, 0x0065, 0x0072, 0x0065, 0x0064, 0x0020, 0x0068,
	0x0061, 0x0072, 0x0064, 0x0077, 0x0061, 0x0072, 0x0065,
	0x003a, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0000, 0x0020,
	0x0043, 0x006c, 0x006f, 0x0063, 0x006b, 0x0020, 0x0074,
	0x0069, 0x006d, 0x0065, 0x003a, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0000, 0x0020, 0x004d, 0x0065,
	0x0064, 0x0069, 0x0061, 0x0020, 0x0073, 0x0074, 0x0061,
	0x0074, 0x0075, 0x0073, 0x003a, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0000, 0x0020, 0x004d, 0x0065, 0x0064, 0x0069,
	0x0061, 0x0020, 0x0074, 0x0065, 0x0073, 0x0074, 0x003a,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0000,
	0x0061, 0x0076, 0x0061, 0x0069, 0x006c, 0x0061, 0x0062,
	0x006c, 0x0065, 0x0000, 0x006e, 0x006f, 0x006e, 0x0065,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0000, 0x0045,
	0x0052, 0x0052, 0x004f, 0x0052, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0000, 0xffff, 0x0073, 0x0075, 0x0063, 0x0063,
	0x0065, 0x0073, 0x0073, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0000, 0x0066, 0x0061, 0x0069, 0x006c, 0x0065, 0x0064,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0000, 0x0069,
	0x006e, 0x0020, 0x0070, 0x0072, 0x006f, 0x0067, 0x0072,
	0x0065, 0x0073, 0x0073, 0x0000, 0xf615, 0x7349, 0x0020,
	0x0020, 0x0058, 0x002e, 0x0020, 0x004c, 0x0045, 0x004d,
	0x002d, 0x0031, 0x0038, 0x0030, 0x0032, 0x0020, 0x004d,
	0x006f, 0x006e, 0x0069, 0x0074, 0x006f, 0x0072, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0000, 0x7406, 0x30cf, 0x0020,
	0x0020, 0x0058, 0x002e, 0x0020, 0x0047, 0x0065, 0x006e,
	0x0065, 0x0072, 0x0069, 0x0063, 0x0020, 0x004b, 0x0065,
	0x0079, 0x0062, 0x006f, 0x0061, 0x0072, 0x0064, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0000, 0xb402, 0x12d0, 0x0020,
	0x0020, 0x0058, 0x002e, 0x0020, 0x0047, 0x0065, 0x006e,
	0x0065, 0x0072, 0x0069, 0x0063, 0x0020, 0x0043, 0x006c,
	0x006f, 0x0063, 0x006b, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0000, 0x4cae, 0x74fa, 0x0020,
	0x0020, 0x0058, 0x002e, 0x0020, 0x0048, 0x004d, 0x0044,
	0x0032, 0x0030, 0x0034, 0x0033, 0x0020, 0x0048, 0x0061,
	0x0072, 0x006f, 0x006c, 0x0064, 0x0020, 0x004d, 0x0065,
	0x0064, 0x0069, 0x0061, 0x0020, 0x0044, 0x0072, 0x0069,
	0x0076, 0x0065, 0x0020, 0x0000, 0xbf3c, 0x42ba, 0x0020,
	0x0020, 0x0058, 0x002e, 0x0020, 0x0053, 0x0050, 0x0045,
	0x0044, 0x0033, 0x0020, 0x0044, 0x0069, 0x0073, 0x0070,
	0x006c, 0x0061, 0x0079, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,
	0x0020, 0x0020, 0x0020, 0x0000, 0x0005, 0xffff, 0xffff,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000
};

/*****************************************************************************
*        JSR subroutine1                                                     *
*                                                                            *
*      :label2                                                               *
*        ADD [0x8000], 1                                                     *
*        SET PC, label2                                                      *
*                                                                            *
*      :subroutine1                                                          *
*        SET Y, 0                                                            *
*        SET Z, 0                                                            *
*                                                                            *
*      :label7                                                               *
*        SET X, 0                                                            *
*        SET B, Y                                                            *
*                                                                            *
*      :label5                                                               *
*        SET C, X                                                            *
*        JSR subroutine3                                                     *
*        ADD Z, 1                                                            *
*        AND Z, 0x00ff                                                       *
*        ADD X, 1                                                            *
*        IFE X, 0x0020                                                       *
*          SET PC, label4                                                    *
*        SET PC, label5                                                      *
*                                                                            *
*      :label4                                                               *
*        ADD Y, 1                                                            *
*        IFE Y, 0x0010                                                       *
*          SET PC, label6                                                    *
*        SET PC, label7                                                      *
*                                                                            *
*      :label6                                                               *
*        SET PC, POP                                                         *
*                                                                            *
*      :subroutine3                                                          *
*        SET PUSH, A                                                         *
*        SET PUSH, B                                                         *
*        SET PUSH, C                                                         *
*        SET A, Y                                                            *
*        SHL A, 5                                                            *
*        ADD A, X                                                            *
*        SHL C, 4                                                            *
*        BOR B, C                                                            *
*        SHL B, label7                                                       *
*        BOR B, Z                                                            *
*        SET [A+0x8000], B                                                   *
*        SET C, POP                                                          *
*        SET B, POP                                                          *
*        SET A, POP                                                          *
*        SET PC, POP                                                         *
******************************************************************************/
DCPU::Word prj4[] = {
	0x7c20, 0x0006, 0x8bc2, 0x8000, 0x7f81, 0x0002, 0x8481, 0x84a1, 0x8461, 0x1021, 0x0c41,
	0x7c20, 0x001e, 0x88a2, 0x7caa, 0x00ff, 0x8862, 0x7c72, 0x0020, 0x7f81, 0x0017, 0x7f81,
	0x000a, 0x8882, 0xc492, 0x7f81, 0x001d, 0x7f81, 0x0008, 0x6381, 0x0301, 0x0701, 0x0b01,
	0x1001, 0x980f, 0x0c02, 0x944f, 0x082b, 0xa42f, 0x142b, 0x0601, 0x8000, 0x6041, 0x6021,
	0x6001, 0x6381, 0x0000, 0x0000
};


int main()
{
   DCPU::DCPUVirtualMachine VM;
   DCPU::LEM::LEM1802 Mon;
   VM.connect(&Mon);

   VM.load(prj4,47);
   std::cout<<VM.dumpstate();
   int ticks = 10000;
   while(ticks--)
   {
      VM.tick();
   }
   std::cout << VM.dumpstate();


   return 0;
}

